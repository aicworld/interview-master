import { atom, selector, DefaultValue, useRecoilValue, useResetRecoilState, useSetRecoilState, useRecoilState } from 'recoil';
import { isEqual, debounce } from 'lodash';
import { v4 } from 'uuid';
import { useCallback, useEffect } from 'react';
import wt from 'socket.io-client';
export { Socket } from 'socket.io-client';
import Ft from 'jwt-decode';
import Mt from 'swr';

var ut=i=>{let t={},e=new Date,s=new Date;s.setDate(e.getDate()-1);let n=new Date;n.setDate(e.getDate()-7);let o=new Date;return o.setDate(e.getDate()-30),i.forEach(a=>{let f=new Date(a.createdAt),g=f.toDateString()===e.toDateString(),m=f.toDateString()===s.toDateString(),h=f>=n,I=f>=o,p;g?p="Today":m?p="Yesterday":h?p="Previous 7 days":I?p="Previous 30 days":p=f.toLocaleString("default",{month:"long",year:"numeric"}).split(" ").slice(0,1).join(" "),t[p]||(t[p]=[]),t[p].push(a);}),t};var X=atom({key:"ThreadIdToResume",default:void 0}),gt=atom({key:"ChatProfile",default:void 0}),dt=atom({key:"SessionId",default:v4()}),B=selector({key:"SessionIdSelector",get:({get:i})=>i(dt),set:({set:i},t)=>i(dt,t instanceof DefaultValue?v4():t)}),v=atom({key:"Session",dangerouslyAllowMutability:!0,default:void 0}),_=atom({key:"Actions",default:[]}),w=atom({key:"Messages",dangerouslyAllowMutability:!0,default:[]}),z=atom({key:"TokenCount",default:0}),R=atom({key:"Loading",default:!1}),M=atom({key:"AskUser",default:void 0}),ht=atom({key:"CallFn",default:void 0}),C=atom({key:"ChatSettings",default:[]}),et=selector({key:"ChatSettingsValue/Default",get:({get:i})=>i(C).reduce((e,s)=>(e[s.id]=s.initial,e),{})}),U=atom({key:"ChatSettingsValue",default:et}),F=atom({key:"DisplayElements",default:[]}),j=atom({key:"AvatarElements",default:[]}),L=atom({key:"TasklistElements",default:[]}),H=atom({key:"FirstUserInteraction",default:void 0}),V=atom({key:"AccessToken",default:void 0}),mt=atom({key:"User",default:null}),St=atom({key:"ThreadHistory",default:{threads:void 0,currentThreadId:void 0,timeGroupedThreads:void 0,pageInfo:void 0},effects:[({setSelf:i,onSet:t})=>{t((e,s)=>{let n=e?.timeGroupedThreads;e?.threads&&!isEqual(e.threads,s?.timeGroupedThreads)&&(n=ut(e.threads)),i({...e,timeGroupedThreads:n});});}]});var Xt=()=>{let i=useRecoilValue(R),t=useRecoilValue(F),e=useRecoilValue(j),s=useRecoilValue(L),n=useRecoilValue(_),o=useRecoilValue(v),a=useRecoilValue(M),f=useRecoilValue(C),g=useRecoilValue(U),m=useRecoilValue(et),h=o?.socket.connected&&!o?.error,I=!h||i||a?.spec.type==="file"||a?.spec.type==="action";return {actions:n,askUser:a,avatars:e,chatSettingsDefaultValue:m,chatSettingsInputs:f,chatSettingsValue:g,connected:h,disabled:I,elements:t,error:o?.error,loading:i,tasklists:s}};var Yt=i=>{let t=[];for(let e of i)t=A(t,e);return t},Jt=(i,t)=>{if(i.length-1===t)return !0;for(let e=t+1;e<i.length;e++)if(!i[e].streaming)return !1;return !0},A=(i,t)=>G(i,t.id)?Y(i,t.id,t):"parentId"in t&&t.parentId?yt(i,t.parentId,t):"indent"in t&&t.indent&&t.indent>0?It(i,t.indent,t):[...i,t],It=(i,t,e,s=0)=>{let n=[...i];if(n.length===0)return [...n,e];{let o=n.length-1,a=n[o];return a.steps=a.steps||[],s+1===t?(a.steps=[...a.steps,e],n[o]={...a},n):(a.steps=It(a.steps,t,e,s+1),n[o]={...a},n)}},yt=(i,t,e)=>{let s=[...i];for(let n=0;n<s.length;n++){let o=s[n];isEqual(o.id,t)?(o.steps=o.steps?[...o.steps,e]:[e],s[n]={...o}):G(s,t)&&o.steps&&(o.steps=yt(o.steps,t,e),s[n]={...o});}return s},G=(i,t)=>{for(let e of i){if(isEqual(e.id,t))return !0;if(e.steps&&e.steps.length>0&&G(e.steps,t))return !0}return !1},Y=(i,t,e)=>{let s=[...i];for(let n=0;n<s.length;n++){let o=s[n];isEqual(o.id,t)?s[n]={steps:o.steps,...e}:G(s,t)&&o.steps&&(o.steps=Y(o.steps,t,e),s[n]={...o});}return s},st=(i,t)=>{let e=[...i];for(let s=0;s<e.length;s++){let n=e[s];n.id===t?e=[...e.slice(0,s),...e.slice(s+1)]:G(e,t)&&n.steps&&(n.steps=st(n.steps,t),e[s]={...n});}return e},nt=(i,t,e,s)=>{let n=[...i];for(let o=0;o<n.length;o++){let a=n[o];isEqual(a.id,t)?("content"in a&&a.content!==void 0?s?a.content=e:a.content+=e:"output"in a&&a.output!==void 0&&(s?a.output=e:a.output+=e),n[o]={...a}):a.steps&&(a.steps=nt(a.steps,t,e,s),n[o]={...a});}return n};var se=()=>{let i=useRecoilValue(V),t=useRecoilValue(v),e=useRecoilValue(M),s=useRecoilValue(B),n=useResetRecoilState(C),o=useResetRecoilState(B),a=useResetRecoilState(U),f=useSetRecoilState(H),g=useSetRecoilState(R),m=useSetRecoilState(w),h=useSetRecoilState(F),I=useSetRecoilState(j),p=useSetRecoilState(L),x=useSetRecoilState(_),b=useSetRecoilState(z),D=useSetRecoilState(X),q=useCallback(()=>{t?.socket.emit("clear_session"),t?.socket.disconnect(),D(void 0),o(),f(void 0),m([]),h([]),I([]),p([]),x([]),b(0),n(),a();},[t]),O=useCallback((y,l)=>{m(r=>A(r,y)),t?.socket.emit("ui_message",{message:y,fileReferences:l});},[t?.socket]),W=useCallback(y=>{e&&(m(l=>A(l,y)),e.callback(y));},[e]),Z=useCallback(y=>{t?.socket.emit("chat_settings_change",y);},[t?.socket]),tt=useCallback(()=>{g(!1),t?.socket.emit("stop");},[t?.socket]),$=useCallback(y=>{let l=t?.socket;if(!l)return;let r=new Promise((c,u)=>{l.once("action_response",d=>{d.status?c(d):u(d);});});return l.emit("action_call",y),r},[t?.socket]);return {uploadFile:useCallback((y,l,r)=>y.uploadFile(l,r,s,i),[s,i]),callAction:$,clear:q,replyMessage:W,sendMessage:O,stopTask:tt,setIdToResume:D,updateChatSettings:Z}};var ie=()=>{let i=useRecoilValue(w),t=useRecoilValue(H);return {messages:i,firstInteraction:t}};var ge=()=>{let i=useRecoilValue(B),[t,e]=useRecoilState(v),s=useResetRecoilState(U),n=useSetRecoilState(H),o=useSetRecoilState(R),a=useSetRecoilState(w),f=useSetRecoilState(M),g=useSetRecoilState(ht),m=useSetRecoilState(F),h=useSetRecoilState(j),I=useSetRecoilState(L),p=useSetRecoilState(_),x=useSetRecoilState(C),b=useSetRecoilState(z),[D,q]=useRecoilState(gt),O=useRecoilValue(X),W=useCallback(({client:$,userEnv:lt,accessToken:y})=>{let l=wt($.httpEndpoint,{path:"/ws/socket.io",extraHeaders:{Authorization:y||"","X-Chainlit-Client-Type":$.type,"X-Chainlit-Session-Id":i,"X-Chainlit-Thread-Id":O||"","user-env":JSON.stringify(lt),"X-Chainlit-Chat-Profile":D||""}});e(r=>(r?.socket?.removeAllListeners(),r?.socket?.close(),{socket:l})),l.on("connect",()=>{l.emit("connection_successful"),e(r=>({...r,error:!1}));}),l.on("connect_error",r=>{e(c=>({...c,error:!0}));}),l.on("task_start",()=>{o(!0);}),l.on("task_end",()=>{o(!1);}),l.on("reload",()=>{l.emit("clear_session"),window.location.reload();}),l.on("resume_thread",r=>{let c=[];for(let d of r.steps)c=A(c,d);r.metadata?.chat_profile&&q(r.metadata?.chat_profile),a(c);let u=r.elements||[];h(u.filter(d=>d.type==="avatar")),I(u.filter(d=>d.type==="tasklist")),m(u.filter(d=>["avatar","tasklist"].indexOf(d.type)===-1));}),l.on("new_message",r=>{a(c=>A(c,r));}),l.on("first_interaction",r=>{n(r);}),l.on("update_message",r=>{a(c=>Y(c,r.id,r));}),l.on("delete_message",r=>{a(c=>st(c,r.id));}),l.on("stream_start",r=>{a(c=>A(c,r));}),l.on("stream_token",({id:r,token:c,isSequence:u})=>{a(d=>nt(d,r,c,u));}),l.on("ask",({msg:r,spec:c},u)=>{f({spec:c,callback:u}),a(d=>A(d,r)),o(!1);}),l.on("ask_timeout",()=>{f(void 0),o(!1);}),l.on("clear_ask",()=>{f(void 0);}),l.on("call_fn",({name:r,args:c},u)=>{let d=new CustomEvent("chainlit-call-fn",{detail:{name:r,args:c,callback:u}});window.dispatchEvent(d),g({name:r,args:c,callback:u});}),l.on("clear_call_fn",()=>{g(void 0);}),l.on("call_fn_timeout",()=>{g(void 0);}),l.on("chat_settings",r=>{x(r),s();}),l.on("element",r=>{!r.url&&r.chainlitKey&&(r.url=$.getElementUrl(r.chainlitKey,i)),r.type==="avatar"?h(c=>{let u=c.findIndex(d=>d.id===r.id);return u===-1?[...c,r]:[...c.slice(0,u),r,...c.slice(u+1)]}):r.type==="tasklist"?I(c=>{let u=c.findIndex(d=>d.id===r.id);return u===-1?[...c,r]:[...c.slice(0,u),r,...c.slice(u+1)]}):m(c=>{let u=c.findIndex(d=>d.id===r.id);return u===-1?[...c,r]:[...c.slice(0,u),r,...c.slice(u+1)]});}),l.on("remove_element",r=>{m(c=>c.filter(u=>u.id!==r.id)),I(c=>c.filter(u=>u.id!==r.id)),h(c=>c.filter(u=>u.id!==r.id));}),l.on("action",r=>{p(c=>[...c,r]);}),l.on("remove_action",r=>{p(c=>{let u=c.findIndex(d=>d.id===r.id);return u===-1?c:[...c.slice(0,u),...c.slice(u+1)]});}),l.on("token_usage",r=>{b(c=>c+r);});},[e,i,D]),Z=useCallback(debounce(W,200),[W]),tt=useCallback(()=>{t?.socket&&(t.socket.removeAllListeners(),t.socket.close());},[t]);return {connect:Z,disconnect:tt,session:t,chatProfile:D,idToResume:O,setChatProfile:q}};var it="token";function at(){try{return localStorage.getItem(it)}catch{return}}function At(i){try{return localStorage.setItem(it,i)}catch{return}}function K(){try{return localStorage.removeItem(it)}catch{return}}var Ut=async(i,t,e)=>(await i.get(t,e))?.json();function Et(i,t,e){let s=useRecoilValue(V);return Mt(t?[t,s]:null,([n,o])=>Ut(i,n,o),e)}var De=i=>{let{data:t,isLoading:e}=Et(i,"/auth/config"),[s,n]=useRecoilState(V),o=useSetRecoilState(St),[a,f]=useRecoilState(mt),g=!!(!e&&t),m=async()=>{await i.logout(),f(null),K(),n(""),o(void 0);},h=p=>{if(!p){m();return}try{let{exp:x,...b}=Ft(p);At(p),n(`Bearer ${p}`),f(b);}catch(x){console.error("Invalid token, clearing token from local storage","error:",x),m();}};useEffect(()=>{if(!a&&at()){h(at());return}},[]);let I=!!s;return t&&!t.requireLogin?{data:t,user:null,isReady:g,isAuthenticated:!0,accessToken:"",logout:()=>{},setAccessToken:()=>{}}:{data:t,user:a,isAuthenticated:I,isReady:g,accessToken:s,logout:m,setAccessToken:h}};var Q=class extends Error{constructor(e,s){super(e);this.detail=s;}toString(){return this.detail?`${this.message}: ${this.detail}`:this.message}},ct=class{constructor(t,e,s,n){this.httpEndpoint=t;this.type=e;this.on401=s;this.onError=n;}buildEndpoint(t){return this.httpEndpoint.endsWith("/")?`${this.httpEndpoint.slice(0,-1)}${t}`:`${this.httpEndpoint}${t}`}checkToken(t){let e="Bearer ";return t.startsWith(e)?t:e+t}async fetch(t,e,s,n,o){try{let a={};s&&(a.Authorization=this.checkToken(s));let f;n instanceof FormData?f=n:(a["Content-Type"]="application/json",f=n?JSON.stringify(n):null);let g=await fetch(this.buildEndpoint(e),{method:t,headers:a,signal:o,body:f});if(!g.ok){let m=await g.json();throw g.status===401&&this.on401&&(K(),this.on401()),new Q(g.statusText,m.detail)}return g}catch(a){throw a instanceof Q&&this.onError&&this.onError(a),console.error(a),a}}async get(t,e){return await this.fetch("GET",t,e)}async post(t,e,s,n){return await this.fetch("POST",t,s,e,n)}async put(t,e,s){return await this.fetch("PUT",t,s,e)}async patch(t,e,s){return await this.fetch("PATCH",t,s,e)}async delete(t,e,s){return await this.fetch("DELETE",t,s,e)}},Ct=class extends ct{async headerAuth(){return (await this.post("/auth/header",{})).json()}async passwordAuth(t){return (await this.post("/login",t)).json()}async logout(){return (await this.post("/logout",{})).json()}async getGeneration(t,e={},s,n,o){let a={userEnv:e};t.type==="CHAT"?a.chatGeneration=t:a.completionGeneration=t;let g=(await this.post("/generation",a,n,s.signal))?.body?.getReader();return new ReadableStream({start(h){function I(){g.read().then(({done:p,value:x})=>{if(p){h.close(),o&&o(p,"");return}let b=new TextDecoder("utf-8").decode(x);o&&o(p,b),h.enqueue(x),I();}).catch(p=>{h.close(),o&&o(!0,""),console.error(p);});}I();}})}async setFeedback(t,e){return (await this.put("/feedback",{feedback:t},e)).json()}async listThreads(t,e,s){return (await this.post("/project/threads",{pagination:t,filter:e},s)).json()}async deleteThread(t,e){return (await this.delete("/project/thread",{threadId:t},e)).json()}uploadFile(t,e,s,n){let o=new XMLHttpRequest,a=new Promise((f,g)=>{let m=new FormData;m.append("file",t),o.open("POST",this.buildEndpoint(`/project/file?session_id=${s}`),!0),n&&o.setRequestHeader("Authorization",this.checkToken(n)),o.upload.onprogress=function(h){if(h.lengthComputable){let I=h.loaded/h.total*100;e(I);}},o.onload=function(){if(o.status===200){let h=JSON.parse(o.responseText);f(h);}else g("Upload failed");},o.onerror=function(){g("Upload error");},o.send(m);});return {xhr:o,promise:a}}getElementUrl(t,e){let s=`?session_id=${e}`;return this.buildEndpoint(`/project/file/${t}${s}`)}getLogoEndpoint(t){return this.buildEndpoint(`/logo?theme=${t}`)}getOAuthEndpoint(t){return this.buildEndpoint(`/auth/oauth/${t}`)}};

export { ct as APIBase, Ct as ChainlitAPI, Q as ClientError, V as accessTokenState, _ as actionState, A as addMessage, yt as addMessageToParent, M as askUserState, j as avatarState, ht as callFnState, gt as chatProfileState, et as chatSettingsDefaultValueSelector, C as chatSettingsInputsState, U as chatSettingsValueState, st as deleteMessageById, F as elementState, Ut as fetcher, H as firstUserInteraction, G as hasMessageById, Jt as isLastMessage, R as loadingState, w as messagesState, Yt as nestMessages, B as sessionIdState, v as sessionState, L as tasklistState, St as threadHistoryState, X as threadIdToResumeState, z as tokenCountState, Y as updateMessageById, nt as updateMessageContentById, Et as useApi, De as useAuth, Xt as useChatData, se as useChatInteract, ie as useChatMessages, ge as useChatSession, mt as userState };
//# sourceMappingURL=out.js.map
//# sourceMappingURL=index.mjs.map